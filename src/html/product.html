<!DOCTYPE HTML>
<html>

<head>
	<title>Products</title>
	<link rel="stylesheet" href="../css/style.css" type="text/css" />
</head>

<body>
	<h2>Products</h2><span id="noOfProducts"></span> records found
	<div>Find Products
		<input type="text" id="search" />
		<button onclick="loadProducts();">Find</button>
	</div>
	<section>
		<div id="ProductContainer">Loading...</div>
	</section>

	<div class="add">
		name:
		<input type="text" id="name" /> price:
		<input type="number" id="price" /> sku:
		<input type="text" id="sku" />
		<button onclick="addProduct();">Add</button>
	</div>

	<script id="RegionTemplate" type="text/x-jQuery-tmpl">
		
	</script>
	
	<script id="ManufacturerTemplate" type="text/x-jQuery-tmpl">
		
	</script>
	
	<script id="ProductTemplate" type="text/x-jQuery-tmpl">
		<div class="row">
			Index: ${$item.dataArrayIndex($item.data)} 
			name: <input type="text" value="${name}" id="${_id}_name" /> 
			price: ${globals.currency} <input type="number" id="${_id}_price" value="${formatPrice(price)}" /> 
			sku: <input type="text" id="${_id}_sku" value="${sku}" />
			region: ${regions}
			manufacturer: ${manufacturers}
			<button onclick="updateProduct('${_id}');">Update</button>
			<button onclick="deleteProduct('${_id}');">Delete</button>
		</div>
	</script>

	<script src="../js/jquery/dist/jquery.min.js"></script>
	<script src="../js/jquery.tmpl.min.js"></script>
	<script>
		var globals = {};
			globals.currency = "$";
			
			function loadProductsCount(){
				$.ajax({
					url: "http://localhost:3001/api/products/count/?name__regex=/^"+$("#search").val()+"/i",
					data: "",
					type: 'GET',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						$("#noOfProducts").html(res);
					},
					error: function(res){
						alert('An error has occured while fetching count!');
					}
				});
			}
			
			function loadProducts(){
				loadProductsCount();
				$.ajax({
					url: "http://localhost:3001/api/products/?limit=10&name__regex=/^"+$("#search").val()+"/i",
					data: "",
					type: 'GET',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						// Render the products using the template
						console.log(new Date());
						$("#ProductContainer").html('');
						$("#ProductTemplate").tmpl(res, {
							dataArrayIndex: function (item) {
								return $.inArray(item, res) + 1;
							}
						}).appendTo("#ProductContainer");
						console.log(new Date());
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			
			
			function updateProduct(id){
				var data ={name:$("#"+id+"_name").val(),price:$("#"+id+"_price").val(),sku:$("#"+id+"_sku").val()};
				$.ajax({
					url: "http://localhost:3001/api/products/"+id,
					data: JSON.stringify(data),
					type: 'PUT',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						console.log('record updated');
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			function deleteProduct(id){
				var data = {name:$("#"+id+"_name").val()};
				$.ajax({
					url: "http://localhost:3001/api/products/"+id,
					data: JSON.stringify(data),
					type: 'DELETE',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						console.log('record deleted');
						loadProducts();
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			
			function addProduct(){
				var data = {name:$("#name").val(),price:$("#price").val(),sku:$("#sku").val()};
				console.log(data);
				$.ajax({
					url: "http://localhost:3001/api/products/",
					data: JSON.stringify(data),
					type: 'POST',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						$("#name").val("");$("#price").val("");$("#sku").val("");
						console.log('record inserted');
						loadProducts();
					},
					error: function(err){
						console.log(err);
						alert(err.message);
					}
				});
			}
			
        function formatPrice(price) {
			if(price===null){return '';}
           	return price.toFixed(2);
        }
		
		var regions = {}, manufacturers = {};
		
		function loadManufacturers(){
			$.ajax({
				url: "http://localhost:3001/api/manufacturers",
				data: "",
				type: 'GET',
				crossDomain: true,
				dataType: 'json',
				contentType: 'application/json',
				success: function(res){
					manufacturers = res;
				},
				error: function(res){
					alert('An error has occured while fetching count!');
				}
			});
		}
		
		function loadRegions(){
			$.ajax({
				url: "http://localhost:3001/api/regions",
				data: "",
				type: 'GET',
				crossDomain: true,
				dataType: 'json',
				contentType: 'application/json',
				success: function(res){
					regions = res;
				},
				error: function(res){
					alert('An error has occured while fetching count!');
				}
			});
		}
		loadManufacturers();
		loadRegions();
		loadProducts();
	</script>
</body>

</html>