<!DOCTYPE HTML>
<html>

<head>
	<title>Products</title>
	<link rel="stylesheet" href="../css/style.css" type="text/css" />
</head>

<body>
	<h2>Products</h2><span id="noOfProducts"></span> records found
	<div>Find Products
		<input type="text" id="search" />
		<button onclick="loadProducts();">Find</button>
	</div>
	<section>
		<div id="ProductContainer">Loading...</div>
	</section>

	<div class="add">
		name:
		<input type="text" id="name" /> price:
		<input type="number" id="price" /> sku:
		<input type="text" id="sku" /> region:
		<select id="region"></select> manufacturer: 
		<select id="manufacturer"></select>
		<button onclick="addProduct();">Add</button>
	</div>

	<script id="RegionTemplate" type="text/x-jQuery-tmpl">
		<option value="${_id}">${name}</option>
	</script>

	<script id="ManufacturerTemplate" type="text/x-jQuery-tmpl">
	
	</script>
	<!--<option value="${_id}">${name}</option>-->
	<script id="ProductTemplate" type="text/x-jQuery-tmpl">
		<div class="row">
			${( $data.index = $item.dataArrayIndex($item.data) ),''} Index: ${$data.index} name:
			<input type="text" value="${name}"
			id="${$data.index}_name" /> price: ${globals.currency}
			<input type="number" id="${$data.index}_price" value="${formatPrice(price)}" /> sku:
			<input type="text" id="${$data.index}_sku" value="${sku}" /> region:
			<select id="${$data.index}_region">{{tmpl(regions) "#RegionTemplate"}}</select>
			manufacturer:
			<select id="${$data.index}_manufacturer">{{tmpl(manufacturers) "#ManufacturerTemplate"}}</select>
			<button onclick="updateProduct('${$data.index}','${_id}');">Update</button>
			<button onclick="deleteProduct('${$data.index}','${_id}');">Delete</button>
		</div>
	</script>

	<script src="../js/jquery/dist/jquery.min.js"></script>
	<script src="../js/jquery.tmpl.min.js"></script>
	<script>
		var globals = {};
			globals.currency = "$";
			
			function loadProductsCount(){
				$.ajax({
					url: "http://localhost:3001/api/products/count/?name__regex=/^"+$("#search").val()+"/i",
					data: "",
					type: 'GET',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						$("#noOfProducts").html(res);
					},
					error: function(res){
						alert('An error has occured while fetching count!');
					}
				});
			}
			
			function loadProducts(){
				loadProductsCount();
				$.ajax({
					url: "http://localhost:3001/api/products/?limit=10&name__regex=/^"+$("#search").val()+"/i",
					data: "",
					type: 'GET',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						// Render the products using the template
						console.log(new Date());
						$("#ProductContainer").html('');
						$("#ProductTemplate").tmpl(res, {
							dataArrayIndex: function (item) {
								return $.inArray(item, res) + 1;
							}
						}).appendTo("#ProductContainer");
						console.log(new Date());
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			
			
			function updateProduct(index,id){
				var data = {
							name: $("#"+index+"_name").val(),
							price: $("#"+index+"_price").val(),
							sku: $("#"+index+"_sku").val()//,
							// manufacturer: $("#"+index+"_manufacturer").val(),
							// region: $("#"+index+"_region").val()
						};
				$.ajax({
					url: "http://localhost:3001/api/products/"+id,
					data: JSON.stringify(data),
					type: 'PUT',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						console.log('record updated');
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			function deleteProduct(index,id){
				var data = {name:$("#"+index+"_name").val()};
				$.ajax({
					url: "http://localhost:3001/api/products/"+id,
					data: JSON.stringify(data),
					type: 'DELETE',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						console.log('record deleted');
						loadProducts();
					},
					error: function(res){
						alert('An error has occured!');
					}
				});
			}
			
			function addProduct(){
				var data = {name:$("#name").val(),price:$("#price").val(),sku:$("#sku").val(),region:$("#region").val()};
				console.log(data);
				$.ajax({
					url: "http://localhost:3001/api/products/",
					data: JSON.stringify(data),
					type: 'POST',
					crossDomain: true,
					dataType: 'json',
					contentType: 'application/json',
					success: function(res){
						$("#name").val("");$("#price").val("");$("#sku").val("");
						console.log('record inserted');
						loadProducts();
					},
					error: function(err){
						debugger;
						console.log(err);
						alert(err.message);
					}
				});
			}
			
        function formatPrice(price) {
			if(price===null){return '';}
           	return price.toFixed(2);
        }
		
		var regions = {}, manufacturers = {};
		
		function loadManufacturers(){
			return false;
			$.ajax({
				url: "http://localhost:3001/api/manufacturers",
				data: "",
				type: 'GET',
				crossDomain: true,
				dataType: 'json',
				contentType: 'application/json',
				success: function(res){
					manufacturers = res;
					fillDropDown('manufacturer',manufacturers);
				},
				error: function(res){
					alert('An error has occured while fetching count!');
				}
			});
		}
		
		function loadRegions(){
			$.ajax({
				url: "http://localhost:3001/api/regions",
				data: "",
				type: 'GET',
				crossDomain: true,
				dataType: 'json',
				contentType: 'application/json',
				success: function(res){
					regions = res;
					fillDropDown('region',regions);
				},
				error: function(res){
					alert('An error has occured while fetching count!');
				}
			});
		}
		
		function fillDropDown(id, source){
			for(var x in source){
				$('<option/>').val(source[x]._id).html(source[x].name).appendTo('#'+id);
			}	
		}
		
		loadManufacturers();
		loadRegions();
		loadProducts();
	</script>
</body>

</html>